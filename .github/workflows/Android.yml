name: CI with Android 13 LTS Kernel
on: [push, pull_request]

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    env:
      LOCALVERSION: -lts13
      UPLOADNAME: custom
      DEVICE: emulator
      BUILD_TIME: ${{ github.run_number }}
    # 输出变量供 test job 使用
    outputs:
      artifact-name: ${{ steps.set-artifact-name.outputs.name }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git make gcc bc bison flex libssl-dev \
          python3-pip libelf-dev libncurses-dev

    - name: Setup repo
      run: |
        sudo curl https://storage.googleapis.com/git-repo-downloads/repo \
          -o /usr/local/bin/repo
        sudo chmod +x /usr/local/bin/repo

    - name: Sync kernel source
      run: |
        mkdir -p ${{ github.workspace }}/kernel-src
        cd ${{ github.workspace }}/kernel-src
        repo init -u https://android.googlesource.com/kernel/manifest.git \
          -b common-android13-5.15-lts -m default.xml --depth=1 \
          --repo-url=https://gerrit.googlesource.com/git-repo
        repo sync -c --no-clone-bundle --no-tags -j$(nproc)

    - name: Setup FMAC
      run: |
        cd ${{ github.workspace }}/kernel-src
        if curl -sSL https://raw.githubusercontent.com/FMAC-Team/FMAC/main/scripts/patch.sh | bash -; then
          echo "FMAC applied successfully"
        else
          echo "FMAC failed, continuing without it"
        fi
      continue-on-error: true

    - name: Setup Android NDK
      uses: android-actions/setup-ndk@v1
      with:
        ndk-version: r25c

    - name: Build kernel
      run: |
        cd ${{ github.workspace }}/kernel-src
        export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        BUILD_CONFIG=common/build.config.gki.x86_64 \
        LTO=thin \
        CC=clang \
        CLANG_TRIPLE=x86_64-linux-gnu- \
        build/build.sh

    - name: Set artifact name
      id: set-artifact-name
      run: |
        NAME="boot${{ env.LOCALVERSION }}-${{ env.UPLOADNAME }}-${{ env.DEVICE }}-${{ env.BUILD_TIME }}"
        echo "name=${NAME}" >> $GITHUB_OUTPUT
        echo "Artifact name: ${NAME}"

    - name: Prepare kernel artifact
      run: |
        cd ${{ github.workspace }}/kernel-src
        mkdir -p upload
        
        # Android GKI 构建通常输出在 out/mixed/dist/
        if [ -f out/mixed/dist/bzImage ]; then
          cp out/mixed/dist/bzImage upload/
          echo "Copied bzImage"
        fi
        
        if [ -f out/mixed/dist/vmlinux ]; then
          cp out/mixed/dist/vmlinux upload/
          echo "Copied vmlinux"
        fi
        
        # 如果有 boot.img
        if [ -f out/mixed/dist/boot.img ]; then
          cp out/mixed/dist/boot.img upload/
          echo "Copied boot.img"
        fi
        
        # 列出文件
        ls -lh upload/
        
        # 创建压缩包
        cd upload
        tar -czf ../kernel-build.tar.gz *

    - name: Upload kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.set-artifact-name.outputs.name }}
        path: ${{ github.workspace }}/kernel-src/kernel-build.tar.gz
        retention-days: 5

  test:
    needs: build-kernel
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - uses: android-actions/setup-android@v3

    - name: Download kernel artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.build-kernel.outputs.artifact-name }}
        path: ./kernel-artifact

    - name: Extract kernel
      run: |
        mkdir -p kernel-extracted
        tar -xzf kernel-artifact/kernel-build.tar.gz -C kernel-extracted/
        ls -lh kernel-extracted/

    - name: Run emulator tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 33
        target: google_apis
        arch: x86_64
        profile: pixel_5
        # 使用 bzImage（x86_64 的标准格式）
        emulator-options: -kernel ./kernel-extracted/bzImage -no-snapshot-load -no-snapshot-save -gpu swiftshader_indirect -no-audio -no-window
        # 如果没有 Gradle 项目，用简单的测试
        script: |
          adb wait-for-device
          adb shell uname -r
          echo "Emulator booted successfully with custom kernel"