name: CI with Custom Kernel
on: [push, pull_request]

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install build tools
      run: |
        sudo apt update
        sudo apt install -y git make gcc bc bison flex libssl-dev
    - name: Clone and build kernel
      run: |
        git clone https://android.googlesource.com/kernel/common -b android-14.0.0_r1
        cd common
        make ARCH=x86_64 goldfish_defconfig
        # 自定义配置（这里简化，实际用 sed 或 echo 编辑 .config）
        echo "CONFIG_DEBUG_KERNEL=y" >> .config
        make ARCH=x86_64 CROSS_COMPILE=x86_64-linux-android- -j$(nproc)
        mkdir -p kernel-out
        cp arch/x86/boot/vmlinux kernel-out/
    - name: Upload kernel artifact
      uses: actions/upload-artifact@v4
      with:
        name: custom-kernel
        path: kernel-out/vmlinux

  test:
    needs: build-kernel
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
    - uses: android-actions/setup-android@v3
    - name: Download kernel
      uses: actions/download-artifact@v4
      with:
        name: custom-kernel
    - name: Run tests with custom kernel
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: x86_64
        profile: pixel_5
        emulator-options: -kernel ./vmlinux -no-snapshot-load -gpu swiftshader_indirect -no-audio -no-window
        script: ./gradlew connectedAndroidTest
