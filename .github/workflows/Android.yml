name: CI with Android 13 LTS Kernel
on: [push, pull_request]

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc bc bison flex libssl-dev
    - name: Setup repo
      run: |
        sudo curl https://storage.googleapis.com/git-repo-downloads/repo -o /bin/repo
        sudo chmod +x /bin/repo

    - name: Sync kernel source
      run: |
        repo init -u https://android.googlesource.com/kernel/manifest.git -b common-android13-5.15-lts -m default.xml --depth=1
        repo --trace sync -c --no-clone-bundle --no-tags --fail-fast -j16
      

    - name: Setup FMAC
      run: |
        curl -sSL https://raw.githubusercontent.com/FMAC-Team/FMAC/main/scripts/patch.sh | bash -

    - name: Build kernel
      run: |
        LTO=full CC=clang BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
  #    continue-on-error: true
        
    - name: Upload boot image
      uses: actions/upload-artifact@v4
      with:
        name: boot${{ env.LOCALVERSION }}${{ env.UPLOADNAME }}-${{ env.DEVICE }}-${{ env.BUILD_TIME }}
        path: out/android13-5.15/dist/boot-img.tar.gz

  test:
    needs: build-kernel
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - uses: android-actions/setup-android@v3
    - name: Download kernel
      uses: actions/download-artifact@v4
      with:
        name: android13-lts-kernel
    - name: Run emulator tests with custom kernel
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 33  # Android 13
        target: google_apis
        arch: x86_64
        profile: pixel_5
        emulator-options: -kernel ./vmlinux -no-snapshot-load -no-snapshot-save -gpu swiftshader_indirect -no-audio -no-window -partition-size 32768M
        script: ./gradlew connectedAndroidTest
