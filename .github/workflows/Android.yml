name: Custom GKI Kernel Android 15 Emulator

on: [push, pull_request, workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      AVD_NAME: custom_avd
      KERNEL_BRANCH: common-android-mainline
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Remove unused packages
        uses: jlumbroso/free-disk-space@main
        with:
           tool-cache: true
           android: false
           dotnet: true
           haskell: true
           large-packages: true
           docker-images: true
           swap-storage: false

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35
          target: google_apis
          arch: x86_64
          components: cmdline-tools;latest,platform-tools,emulator,system-images;android-35;google_apis;x86_64
          accept-licenses: true

      - name: Install System Image Explicitly
        run: |
          sdkmanager "system-images;android-35;google_apis;x86_64"

      - name: Cache AVD
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: ${{ runner.os }}-avd-${{ env.AVD_NAME }}-35

      - name: Create AVD
        run: |
          echo "no" | "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" create avd -n "$AVD_NAME" -k "system-images;android-35;google_apis;x86_64" -d pixel --force

      - name: Setup Bazelisk
        uses: bazelbuild/setup-bazelisk@v3
        with:
          bazelisk-version: v1.19.0

      - name: Cache Kernel Source
        uses: actions/cache@v4
        with:
          path: kernel
          key: ${{ runner.os }}-kernel-${{ env.KERNEL_BRANCH }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-kernel-${{ env.KERNEL_BRANCH }}-
            ${{ runner.os }}-kernel-

      - name: Build Custom GKI Kernel
        timeout-minutes: 30
        run: |
          # 安装 repo 工具
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          
          # 克隆/同步内核源代码
          mkdir -p kernel && cd kernel
          if [ ! -d ".repo" ]; then
            echo "初始化 repo..."
            repo init -u https://android.googlesource.com/kernel/manifest.git -b common-android13-5.15-lts -m default.xml --depth=1
            repo --trace sync -c --no-clone-bundle --no-tags --fail-fast -j16
          else
            echo "更新现有 repo..."
            repo sync -j$(nproc) -c --no-tags
          fi
          
          # 构建 GKI 内核
          tools/bazel run //common-modules/virtual-device:virtual_device_x86_64_dist -- --destdir=out
          
          # 检查实际的输出目录结构
          echo "=== 检查输出目录 ==="
          ls -la out/ || echo "out/ 不存在"
          
          # 查找 bzImage 文件
          BZIMAGE_PATH=$(find out -name "bzImage" -type f | head -n 1)
          
          if [ -z "$BZIMAGE_PATH" ]; then
            echo "错误: 找不到 bzImage 文件"
            echo "out/ 目录内容:"
            find out -type f -name "*.img" -o -name "bzImage" -o -name "Image*"
            exit 1
          fi
          
          echo "找到内核镜像: $BZIMAGE_PATH"
          echo "KERNEL_PATH=$(pwd)/$BZIMAGE_PATH" >> $GITHUB_ENV

      - name: Launch Emulator with Custom Kernel
        timeout-minutes: 10
        run: |
          echo "使用内核: $KERNEL_PATH"
          
          # 验证内核文件存在
          if [ ! -f "$KERNEL_PATH" ]; then
            echo "错误: 内核文件不存在: $KERNEL_PATH"
            exit 1
          fi
          
          # 启动模拟器
          "$ANDROID_HOME/emulator/emulator" \
            -avd "$AVD_NAME" \
            -kernel "$KERNEL_PATH" \
            -no-window \
            -no-audio \
            -gpu swiftshader_indirect \
            -no-snapshot-load \
            -no-boot-anim \
            -verbose \
            -show-kernel > emulator.log 2>&1 &
          
          # 等待设备启动
          "$ANDROID_HOME/platform-tools/adb" wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
          
          echo "模拟器启动成功"
          "$ANDROID_HOME/platform-tools/adb" shell getprop ro.build.version.release
          "$ANDROID_HOME/platform-tools/adb" shell uname -r

      - name: Run Tests
        run: |
          ./gradlew connectedCheck || true

      - name: Stop Emulator
        if: always()
        run: |
          "$ANDROID_HOME/platform-tools/adb" emu kill || true

      - name: Upload Logs and Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            emulator.log
        #    kernel/out/