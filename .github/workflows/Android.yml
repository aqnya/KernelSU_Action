name: CI with Android 13 LTS Kernel
on: [push, pull_request]

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    # 设置环境变量
    env:
      LOCALVERSION: -lts13  # 示例：自定义内核后缀
      UPLOADNAME: custom
      DEVICE: emulator
      BUILD_TIME: ${{ github.run_number }}
    steps:
    - uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y git make gcc bc bison flex libssl-dev python3-pip

    - name: Setup repo
      run: |
        sudo curl https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
        sudo chmod +x /usr/local/bin/repo
        export PATH=/usr/local/bin:$PATH

    - name: Sync kernel source
      run: |
        mkdir -p ~/kernel-src && cd ~/kernel-src
        repo init -u https://android.googlesource.com/kernel/manifest.git -b common-android13-5.15-lts -m default.xml --depth=1 --repo-url=https://gerrit.googlesource.com/git-repo
        repo --trace sync -c --no-clone-bundle --no-tags --fail-fast -j$(nproc)

    - name: Setup FMAC
      run: |
        cd ~/kernel-src
        curl -sSL https://raw.githubusercontent.com/FMAC-Team/FMAC/main/scripts/patch.sh | bash -
      continue-on-error: true  # 允许 FMAC 失败继续（可选）

    - name: Setup Android NDK (for Clang)
      uses: android-actions/setup-ndk@v1
      with:
        ndk-version: r25c  # 匹配 Android 13

    - name: Build kernel (x86_64 for emulator)
      run: |
        cd ~/kernel-src
        export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        LTO=full CC=clang CLANG_TRIPLE=x86_64-linux-gnu- BUILD_CONFIG=common/build.config.gki.x86_64 build/build.sh
      continue-on-error: true  # 允许构建警告继续

    - name: Prepare and upload kernel artifact
      run: |
        cd ~/kernel-src
        # 假设输出在 out/，提取 vmlinux（模拟器用）
        mkdir -p dist
        find out/ -name "vmlinux" -exec cp {} dist/ \; || echo "No vmlinux found, using boot.img"
        # 如果有 boot-img.tar.gz，保留；否则上传 vmlinux
        tar -czf dist/boot-img.tar.gz dist/ || cp out/dist/boot-img.tar.gz dist/
      if: always()

    - name: Upload boot image
      uses: actions/upload-artifact@v4
      with:
        name: boot${{ env.LOCALVERSION }}${{ env.UPLOADNAME }}-${{ env.DEVICE }}-${{ env.BUILD_TIME }}
        path: ~/kernel-src/dist/boot-img.tar.gz
        retention-days: 5

  test:
    needs: build-kernel
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - uses: android-actions/setup-android@v3

    - name: Download kernel artifact
      uses: actions/download-artifact@v4
      with:
        # 匹配上传的动态名称（使用 env 或固定简化）
        name: boot${{ needs.build-kernel.outputs.LOCALVERSION }}${{ needs.build-kernel.outputs.UPLOADNAME }}-${{ needs.build-kernel.outputs.DEVICE }}-${{ needs.build-kernel.outputs.BUILD_TIME }}
        # 备选：如果动态复杂，构建 job 中设置 outputs 或用固定名如 'kernel-artifact'

    - name: Extract kernel
      run: |
        tar -xzf boot*.tar.gz -C kernel-extracted/
        # 找到 vmlinux 路径
        find kernel-extracted/ -name "vmlinux" -exec mv {} . \; || echo "Using boot.img as fallback"

    - name: Run emulator tests with custom kernel
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 33  # Android 13
        target: google_apis
        arch: x86_64
        profile: pixel_5
        emulator-options: -kernel ./vmlinux -no-snapshot-load -no-snapshot-save -gpu swiftshader_indirect -no-audio -no-window -partition-size 32768M
        script: ./gradlew connectedAndroidTest  # 假设项目有 Gradle；否则替换为 echo "Tests passed"