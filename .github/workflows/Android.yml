name: Custom GKI Kernel Android 15 Emulator

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      AVD_NAME: custom_avd
      KERNEL_BRANCH: common-android15-6.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35  # Android 15
          target: google_apis
          arch: x86_64
          components: cmdline-tools;latest,platform-tools,emulator,system-images;android-35;google_apis;x86_64
          accept-licenses: true

      - name: Install System Image Explicitly
        run: |
          sdkmanager "system-images;android-35;google_apis;x86_64"

      - name: Cache AVD
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: ${{ runner.os }}-avd-${{ hashFiles('*.ini') }}

      - name: Create AVD
        run: |
          echo "no" | "$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager" create avd -n "$AVD_NAME" -k "system-images;android-35;google_apis;x86_64" -d pixel --force --package "android-35"

      - name: Setup Bazelisk
        uses: bazelbuild/setup-bazelisk@v3

      - name: Build Custom GKI Kernel
        run: |
          # 安装 repo 工具
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          # 克隆内核源代码
          mkdir kernel && cd kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b "$KERNEL_BRANCH"
          repo sync -j$(nproc) -c -f --force-sync
          # 构建 virtual_device_x86_64（GKI 内核）
          tools/bazel run //common-modules/virtual-device:virtual_device_x86_64_dist -- --destdir=out
          # 输出路径（bzImage 为 x86_64 内核镜像）
          echo "KERNEL_PATH=$(pwd)/out/virtual_device_x86_64/dist/bzImage" >> $GITHUB_ENV

      - name: Launch Emulator with Custom Kernel
        run: |
          nohup "$ANDROID_HOME/emulator/emulator" \
            -avd "$AVD_NAME" \
            -kernel "$KERNEL_PATH" \
            -no-window \
            -no-audio \
            -gpu swiftshader_indirect \
            -no-snapshot-load \
            -verbose \
            -show-kernel > emulator.log 2>&1 &
          EMULATOR_PID=$!
          timeout=300
          while [ $timeout -gt 0 ]; do
            "$ANDROID_HOME/platform-tools/adb" wait-for-device
            if [ $? -eq 0 ]; then
              echo "Emulator started successfully"
              break
            fi
            sleep 10
            timeout=$((timeout-10))
          done
          if [ $timeout -eq 0 ]; then
            echo "Emulator failed to start"
            cat emulator.log
            exit 1
          fi
          "$ANDROID_HOME/platform-tools/adb" shell getprop ro.build.version.release  # 应输出 15
          "$ANDROID_HOME/platform-tools/adb" shell uname -r  # 显示自定义 GKI 内核版本

      - name: Run Tests
        run: |
          ./gradlew connectedCheck || true
          "$ANDROID_HOME/platform-tools/adb" -s emulator-5554 emu kill

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: emulator.log